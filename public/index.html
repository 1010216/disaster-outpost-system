<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ æ™ºæ…§ç½å®³ç›£æ§ç³»çµ±</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 400px; margin-bottom: 20px; }
    .user-location-marker { z-index: 1000; }
  </style>
</head>
<body>
  <h1>ğŸŒ æ™ºæ…§ç½å®³ç›£æ§ç³»çµ±</h1>

  <section>
    <h2>ğŸŒ¤ï¸ æ°£è±¡è³‡æ–™</h2>
    <div id="weather">è¼‰å…¥ä¸­...</div>
  </section>

  <section>
    <h2>ğŸ’§ æ°´ä½è³‡æ–™</h2>
    <div id="waterLevel">è¼‰å…¥ä¸­...</div>
  </section>

  <section>
    <h2>ğŸŒ‹ åœ°éœ‡è³‡æ–™</h2>
    <div id="earthquake">è¼‰å…¥ä¸­...</div>
  </section>

  <section>
    <h2>ğŸ—ºï¸ ç½å®³åœ°åœ–</h2>
    <div id="map"></div>
    <button id="locationBtn">ğŸ“ å®šä½æˆ‘</button>
  </section>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    let markers = [];
    let userMarker = null;

    const systemData = { 
      waterStations: [], 
      disasterPoints: [], 
      userLocation: null 
    };

    // åˆå§‹åŒ–åœ°åœ–
    function initMap() {
      map = L.map('map').setView([25.0330, 121.5654], 8); // å°åŒ—
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
      }).addTo(map);
    }

    // å–å¾—ç½å®³è³‡æ–™ä¸¦æ›´æ–°åœ°åœ–æ¨™è¨˜
    async function loadDisasters() {
      try {
        const res = await fetch("/api/water");
        const data = await res.json();
        systemData.waterStations = data;

        // æ¸…é™¤èˆŠæ¨™è¨˜
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        data.forEach(item => {
          const color = item.level > item.alert ? '#ef4444' : '#10b981';
          const marker = L.circleMarker([item.lat || 25.0, item.lng || 121.5], {
            radius: 8,
            fillColor: color,
            color: '#fff',
            weight: 2,
            fillOpacity: 0.8
          }).addTo(map);

          marker.bindPopup(`
            <div>
              æ²³æµï¼š${item.river} <br>
              æ°´ä½ï¼š${item.waterLevel} m<br>
            </div>
          `);
          markers.push(marker);
        });

      } catch {
        console.log("ç„¡æ³•å–å¾—æ°´ä½è³‡æ–™");
      }
    }

    // æ›´æ–°æ°£è±¡
    async function loadWeather() {
      try {
        const res = await fetch("/api/weather");
        const data = await res.json();
        document.getElementById("weather").innerHTML = `
          åœ°é»ï¼š${data.locationName}<br>
          å¤©æ°£ï¼š${data.weather}<br>
          æº«åº¦ï¼š${data.minT}Â°C - ${data.maxT}Â°C
        `;
      } catch {
        document.getElementById("weather").innerHTML = "âš ï¸ ç„¡æ³•å–å¾—æ°£è±¡è³‡æ–™";
      }
    }

    // æ›´æ–°æ°´ä½
   async function loadWaterLevel() {
      const el = document.getElementById("waterLevel");
      try {
        // é€™è£¡è«‹ç”¨ã€Œæ·¡æ°´æ²³æµã€ï¼Œä¸æ˜¯ã€Œæ·¡æ°´æ²³ã€
        const res = await fetch("/api/waterLevel?station=æ·¡æ°´æ²³");
        const data = await res.json();

        // æª¢æŸ¥ API æ˜¯å¦å›å‚³éŒ¯èª¤
        if (data.error) {
          el.innerHTML = `âš ï¸ ${data.error}`;
          return;
        }

        // æ­£å¸¸æ›´æ–°ç•«é¢
        el.innerHTML = `
          æ²³æµï¼š${data.RiverName}<br>
          æ°´ä½ï¼š${data.WaterLevel} m<br>
          æ›´æ–°æ™‚é–“ï¼š${data.RecordTime} 
        `;
      } catch (err) {
        el.innerHTML = "âš ï¸ ç„¡æ³•å–å¾—æ°´ä½è³‡æ–™";
        console.error("æ°´ä½è®€å–å¤±æ•—ï¼š", err);
      }
    }

    // âš ï¸ ä¸€å®šè¦å‘¼å«é€™è¡Œ
    loadWaterLevel();

    // æ›´æ–°åœ°éœ‡
    async function loadEarthquake() {
      try {
        const res = await fetch("/api/earthquake");
        const data = await res.json();
        document.getElementById("earthquake").innerHTML = `
          ç™¼ç”Ÿæ™‚é–“ï¼š${data.time}<br>
          ä½ç½®ï¼š${data.location}<br>
          è¦æ¨¡ï¼š${data.magnitude}
        `;
      } catch {
        document.getElementById("earthquake").innerHTML = "âš ï¸ ç„¡æ³•å–å¾—åœ°éœ‡è³‡æ–™";
      }
    }

    // å–å¾—ä½¿ç”¨è€…ä½ç½®
    function getUserLocation() {
      const btn = document.getElementById('locationBtn');
      btn.textContent = 'ğŸ“ å®šä½ä¸­...';
      btn.disabled = true;

      if (!navigator.geolocation) {
        alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
        btn.textContent = 'ğŸ“ å®šä½æˆ‘';
        btn.disabled = false;
        return;
      }

      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        systemData.userLocation = { lat, lng };

        if (userMarker) map.removeLayer(userMarker);

        userMarker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: 'user-location-marker',
            html: '<div style="background: #3b82f6; width: 12px; height: 12px; border-radius: 50%; border: 3px solid white;"></div>',
            iconSize: [18, 18],
            iconAnchor: [9, 9]
          })
        }).addTo(map);

        userMarker.bindPopup('ğŸ“ æ‚¨çš„ä½ç½®').openPopup();
        map.setView([lat, lng], 10);
        btn.textContent = 'ğŸ“ é‡æ–°å®šä½';
        btn.disabled = false;
      }, () => {
        alert("ç„¡æ³•å–å¾—ä½ç½®");
        btn.textContent = 'ğŸ“ å®šä½æˆ‘';
        btn.disabled = false;
      });
    }

    // åŒæ­¥æ›´æ–°æ‰€æœ‰è³‡æ–™
    async function loadAll() {
      await Promise.all([loadWeather(), loadEarthquake(), loadDisasters()]);
    }

    // åˆå§‹åŒ–
    initMap();
    loadAll();
    setInterval(loadAll, 60*1000); // æ¯60ç§’æ›´æ–°
    document.getElementById('locationBtn').addEventListener('click', getUserLocation);

  </script>
 <!-- å…¨è¢å¹• EEW è­¦å ± -->
<div id="eewAlertFull" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background-color:red;
  color:white;
  font-size:2em;
  text-align:center;
  z-index:9999;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
">
  <h1>âš ï¸ åœ°éœ‡è­¦å ±</h1>
  <p id="eewInfoFull"></p>
  <p>é ä¼° <span id="eewCountdownFull"></span> ç§’å¾Œå¼·çƒˆæ–æ™ƒ</p>
  <button id="closeEEW" style="
    margin-top:20px;
    padding:10px 20px;
    font-size:1.2em;
    background:white;
    color:red;
    border:none;
    cursor:pointer;
  ">é—œé–‰</button>
</div>

<!-- æ¨¡æ“¬æ¸¬è©¦æŒ‰éˆ• -->
<button id="testBtn">æ¨¡æ“¬åœ°éœ‡è­¦å ±</button>

<script>
  const ws = new WebSocket('ws://localhost:3001')
  let timerFull = null

  function showEEWFull(data) {
    const alertDiv = document.getElementById('eewAlertFull')
    alertDiv.style.display = 'flex' // flex è®“å…§å®¹ç½®ä¸­

    document.getElementById('eewInfoFull').innerText = `è¦æ¨¡ ${data.magnitude}ï¼Œè·é›¢ ${data.distance || '?'} km`

    let t = data.sWaveArriveIn
    document.getElementById('eewCountdownFull').innerText = t

    clearInterval(timerFull)
    timerFull = setInterval(() => {
      t--
      document.getElementById('eewCountdownFull').innerText = t
      if (t <= 0) clearInterval(timerFull)
    }, 1000)
  }

  // WebSocket æ”¶åˆ° EEW
  ws.onmessage = e => {
    const data = JSON.parse(e.data)
    if (data.type === 'EEW') showEEWFull(data)
  }

  // æ¨¡æ“¬æŒ‰éˆ•
  document.getElementById('testBtn').addEventListener('click', () => {
  const testData = {
    type: 'EEW',
    magnitude: 6.5,
    distance: 50,
    sWaveArriveIn: 15,
    originTime: new Date().toISOString()
  }
  showEEWFull(testData)
})


  // é—œé–‰æŒ‰éˆ•
  document.getElementById('closeEEW').addEventListener('click', () => {
    document.getElementById('eewAlertFull').style.display = 'none'
    clearInterval(timerFull)
  })
</script>

</body>
</html>

